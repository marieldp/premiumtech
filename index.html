<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@0;1&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* Restoring your original dark/gold theme */
        :root {
            --gold: #c5a059;
            --dark-blue: #1a2a6c;
            --off-white: #fcfaf7;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--off-white);
            font-family: 'Lato', sans-serif;
            color: #333;
        }

        /* The Envelope Animation you had */
        #envelope-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s ease;
        }

        .envelope {
            position: relative;
            width: 300px; height: 200px;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .envelope::before {
            content: '';
            position: absolute;
            top: 0; z-index: 2;
            border-left: 150px solid transparent;
            border-right: 150px solid transparent;
            border-top: 100px solid #ddd;
            transform-origin: top;
            transition: transform 0.5s 0.5s ease;
        }

        #envelope-wrapper.open .envelope::before {
            transform: rotateX(180deg);
            z-index: 0;
        }

        #envelope-wrapper.open {
            opacity: 0;
            pointer-events: none;
        }

        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 40px;
            text-align: center;
        }

        h2 { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: #111; }
        label { display: block; margin-top: 25px; text-align: left; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; }
        
        select, input, textarea {
            width: 100%; padding: 12px; margin-top: 8px;
            border: none; border-bottom: 1px solid #ccc;
            background: transparent; font-family: inherit; font-size: 1rem;
        }

        .btn {
            background-color: var(--dark-blue);
            color: white; padding: 15px 40px; border: none;
            letter-spacing: 2px; cursor: pointer; margin-top: 40px; width: 100%;
        }

        #p1-area { margin-top: 10px; border-left: 2px solid var(--gold); padding-left: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="envelope-wrapper" onclick="openInvitation()">
        <div class="envelope">
            <div style="position:absolute; top:45%; width:100%; text-align:center; font-family:'Playfair Display'; font-style:italic;">
                Open Invitation
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="hidden">Locating your invitation...</div>
        <div id="error-msg" class="hidden"><h2>Invitation not found.</h2></div>

        <div id="content" class="hidden">
            </div>
    </div>

    <script>
        const webAppUrl = "https://script.google.com/macros/s/AKfycbxYnSDLsvodsS1EfmTrM0b3EWSb9IE9FP8v7_2FJlA52cgokuMf4hDUe6m_vOctiaZM/exec"; 
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('id');
        let guestData = null;

        function openInvitation() {
            const wrapper = document.getElementById('envelope-wrapper');
            wrapper.classList.add('open');
            if (token) {
                document.getElementById('loading').classList.remove('hidden');
                checkGuestStatus();
            }
        }

        function checkGuestStatus() {
            fetch(`${webAppUrl}?id=${encodeURIComponent(token)}`)
                .then(res => res.json())
                .then(data => {
                    guestData = data;
                    document.getElementById('loading').classList.add('hidden');
                    if (data.name) {
                        data.isDone ? showDoneView(data) : showMainForm();
                    } else {
                        document.getElementById('error-msg').classList.remove('hidden');
                    }
                });
        }

        function showMainForm() {
            const content = document.getElementById('content');
            content.classList.remove('hidden');
            
            const rawP1 = String(guestData.allowPlusOne || '').toLowerCase().trim();
            const canP1 = (rawP1 === "true" || rawP1 === "yes" || rawP1 === "1");

            content.innerHTML = `
                <h2>Hi ${guestData.name},</h2>
                
                <label>Attendance</label>
                <select id="attending-select" onchange="togglePlusOne(${canP1})">
                    <option value="Yes">Yes, I'll be there!</option>
                    <option value="No">No, I can't make it</option>
                </select>

                <div id="p1-area"></div>

                <label>Email</label>
                <input type="email" id="guest-email" placeholder="Your email address">

                <label>Message</label>
                <textarea id="guest-note" placeholder="Any dietary needs or notes?"></textarea>

                <button class="btn" id="submit-btn" onclick="submitRSVP()">CONFIRM RSVP</button>
            `;
            togglePlusOne(canP1);
        }

        function togglePlusOne(canP1) {
            const area = document.getElementById('p1-area');
            const att = document.getElementById('attending-select').value;
            if (att === "Yes" && canP1) {
                area.innerHTML = `
                    <label>Bringing a Guest?</label>
                    <select id="bringing-p1" onchange="toggleP1Name()">
                        <option value="No">No, coming solo</option>
                        <option value="Yes">Yes, I'm bringing someone</option>
                    </select>
                    <div id="p1-name-wrapper"></div>
                `;
            } else { area.innerHTML = ''; }
        }

        function toggleP1Name() {
            const wrapper = document.getElementById('p1-name-wrapper');
            const bringing = document.getElementById('bringing-p1').value;
            if (bringing === "Yes") {
                wrapper.innerHTML = '<label>Plus One Name</label><input type="text" id="plus-one-name" placeholder="Their full name">';
            } else { wrapper.innerHTML = ''; }
        }

        function showDoneView(data) {
            const content = document.getElementById('content');
            content.classList.remove('hidden');
            content.innerHTML = `
                <h2>Thank You.</h2>
                <p>We have received your RSVP, ${data.name}.</p>
                <button onclick="showMainForm()" style="background:none; border:none; color:#888; text-decoration:underline; cursor:pointer; margin-top:20px;">
                    Change your mind? Edit RSVP
                </button>
            `;
        }

        function submitRSVP() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerHTML = "SAVING...";
            
            const p1NameInput = document.getElementById('plus-one-name');
            const payload = {
                token: token,
                name: guestData.name,
                email: document.getElementById('guest-email').value,
                attending: document.getElementById('attending-select').value,
                plusOneName: p1NameInput ? p1NameInput.value : "None",
                note: document.getElementById('guest-note').value
            };

            fetch(webAppUrl, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) })
                .then(() => {
                    setTimeout(() => showDoneView({ ...guestData }), 500);
                });
        }
    </script>
</body>
</html>
